### 内存的虚拟化（下）———— 迭代

#### 引言
在前一章中我们简单的聊了聊三种虚拟化的实现方式。本章我们聊聊从简单的线性转换到分段转换，从分段转换到现代主流的分页转换，在这背后推动其迭代的原因是什么？从前一章我们看到线性转换不仅实现了虚拟化，同时实现方式还简单。那么我们为什么还需要分段与分页转换呢？这与两个问题密切相关————**外部碎片**与**动态扩展负担**。

##### 外部碎片
外部碎片是内存中连续已分配空间之间较小的未分配空间。外部碎片中的外部指的是已分配空间的外部，碎片指的是很难再被使用的空闲内存空间（空闲空间较小时）。外部碎片来源于不同大小内存块的随机分配/回收。  
举个例子：有一块内存30B，0B\~10B属于A进程，11B\~18B属于B进程，19B\~25B属于C进程，26B\~29B空闲。在0时刻B进程执行完毕，内存被回收，此时11B\~18B与26B\~29B空闲。在t时刻D进程加载，D进程需要10B的内存，但此时虽空闲空间总大小是12B，但单个最大只有8B。所以D进程会因内存不足而加载失败。11B\~18B与26B\~29B便称为外部碎片。  

##### 动态扩展负担
随着计算机应用场景的发展，人们开始需求动态扩展内存的能力，用于存储动态数据。动态数据是一种在程序运行时，才能确定大小的数据。比如：用户的输入，来自网络的数据包等等。进程内存空间中的堆段便由此而来。

#### 表现
先来看看线性转换的表现。线性转换使用一整块连续物理内存存储数据，因此无法避免外部碎片的存在。在进行动态扩展时，需要移动整块物理内存中的数据，负挰很重。  
再看分段转换的表现。分段转换使用四块连续的物理内存块存储数据。同样无法避免外碎片的产生，但相较于线性转换，由于分段转换将进程的内存空间分为四段使用，每段所需的物理内存更小，能使用更多的外部碎片，因此内存利用率更高。在进行动态扩展时，由于只需移动堆段的数据，所以负担也小于线性转换。  
最后来看分页转换。分页转换使用特定大小的物理页存储数据。在这种情况下不存在无法使用的内存块，所以没有外部碎片。在动态扩展时，只需启用新的虚拟页即可，扩展负担极低。  
补充：在权限控制能力方面，绪性转换 < 分段转换 < 分页转换。原因在于：从线性转换直到分页转换，映射对象从整个进程内存空间到固定大小的页，映射对象越来越小，能控制访问权限的对象便越来越精细。
